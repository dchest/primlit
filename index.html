<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title>Primitive literate programming system for Scheme</title>
<meta name="author" content="Dmitry Chestnykh" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="primitive-literate-programming-system-for-scheme">
<h1 class="title">Primitive literate programming system for Scheme</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Dmitry Chestnykh</td></tr>
<tr><th class="docinfo-name">Version:</th>
<td>0.4 (2011-11-29)</td></tr>
<tr class="field"><th class="docinfo-name">License:</th><td class="field-body"><a class="reference external" href="https://en.wikipedia.org/wiki/ISC_license">ISC</a></td>
</tr>
</tbody>
</table>
<style>
pre.program {
    color: navy;
    border-left: 8px solid #eee;
    padding-left: 16px;
    margin-left: 0;
}
</style><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#example" id="id2">Example</a></li>
<li><a class="reference internal" href="#usage" id="id3">Usage</a></li>
<li><a class="reference internal" href="#the-program" id="id4">The Program</a><ul>
<li><a class="reference internal" href="#text-processing" id="id5">Text Processing</a></li>
<li><a class="reference internal" href="#styling" id="id6">Styling</a></li>
<li><a class="reference internal" href="#additional-markup" id="id7">Additional Markup</a></li>
<li><a class="reference internal" href="#main-loop" id="id8">Main Loop</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id1">Introduction</a></h1>
<p>This almost <a class="reference external" href="https://en.wikipedia.org/wiki/Literate_programming">literate programming</a> system uses <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> inside line
comments in Scheme code for writing, and normal Scheme code as a program. That
is, the source code is runnable without conversion, but generating the book
requires conversion. It is similar to <a class="reference external" href="http://jashkenas.github.com/docco/">Docco</a>.</p>
<p>This program prepares source code for feeding it into reStructuredText tools,
such as <cite>rst2html</cite>. Basically, it extracts text from comments by stripping ';'
from the beginning, and transforms program code into code blocks with a few
added CSS classes (<cite>program</cite> and <cite>language-scheme</cite>).</p>
<p>The rules are simple:</p>
<ul class="simple">
<li>text blocks are separated from program code with blank lines.</li>
<li>lines of text blocks begin with semicolon and space: <tt class="docutils literal">&quot;; &quot;</tt>.</li>
<li>everything inside text blocks is formatted with reStructuredText.</li>
<li>everything between text blocks is program code.</li>
</ul>
</div>
<div class="section" id="example">
<h1><a class="toc-backref" href="#id2">Example</a></h1>
<pre class="literal-block">
; This is a comment and a *text block*.
; It spans five lines, after it goes a blank line, and program code.
;
; The following procedure :proc:`greeting` accepts variable :var:`x`,
; and displays the greeting.

(define (greeting x)
  (display (string-append &quot;Greetings from program code, &quot; x)))

; Text continues here...
</pre>
<p>For another example, view the <a class="reference external" href="http://dchest.github.io/primlit/primlit.scm.txt">source code for this document</a>.</p>
</div>
<div class="section" id="usage">
<h1><a class="toc-backref" href="#id3">Usage</a></h1>
<p>This program reads from standard input and writes to standard output.
Run it on your source and then feed the output to <cite>rst2html</cite>, for example:</p>
<pre class="literal-block">
$ guile -s primlit.scm &lt; your_source.scm | rst2html &gt; output.html
</pre>
</div>
<div class="section" id="the-program">
<h1><a class="toc-backref" href="#id4">The Program</a></h1>
<div class="section" id="text-processing">
<h2><a class="toc-backref" href="#id5">Text Processing</a></h2>
<p>Text lines (lines that are not program code) begin with semicolon.  Let's
write a function to distinguish such lines. It will accept a string <tt class="variable docutils literal">s</tt>
and return <tt class="value docutils literal">#t</tt> if it's a text line.</p>
<pre class="program language-scheme literal-block">
(define (text-line? s)
  (and (&gt; (string-length s) 0)
       (char=? (string-ref s 0) #\;)))
</pre>
<p>To output text lines, we should strip semicolon and maybe a space from it.
The following function does exactly this, and outputs the result:</p>
<pre class="program language-scheme literal-block">
(define (output-text-line s)
  (display
    (substring s
               (if (and (&gt;= (string-length s) 2)
                        (char=? (string-ref s 1) #\ ))
                 2  ; cut two characters, semicolon and space
                 1) ; cut one character, semicolon
               (string-length s))))
</pre>
<p>Outputting code lines is easier, we just have to keep in mind that code blocks
must be indented by two spaces for reStructuredText to format them correctly.</p>
<pre class="program language-scheme literal-block">
(define (output-code-line s)
  (display (string-append &quot;  &quot; s)))
</pre>
</div>
<div class="section" id="styling">
<h2><a class="toc-backref" href="#id6">Styling</a></h2>
<p>To distinguish program code from other <tt class="docutils literal">pre</tt> blocks in output, we'll assign
special classes to <tt class="docutils literal">pre</tt> blocks with code.</p>
<p>This functions outputs a special markup to let reStructuredText know that it
needs to add <tt class="docutils literal">program</tt> and <tt class="docutils literal"><span class="pre">language-scheme</span></tt> to the classes of <tt class="docutils literal">pre</tt>
element that wraps the program code.</p>
<pre class="program language-scheme literal-block">
(define (start-code-block)
  (display &quot;\n.. class :: program language-scheme\n\n::\n\n  &quot;))
</pre>
<p>Default styles shipped with reStructuredText tools don't know about such
classes, so we need to add our own style. Instead of creating templates, let's
just put this quick hack, which only works with <tt class="docutils literal">rst2html</tt>, but not
<tt class="docutils literal">rst2latex</tt> and other tools -- a CSS style block that makes program code
appear in navy color and adds a thick vertical border to the left.</p>
<p>We'll write this directly, so that it appears before any other output:</p>
<pre class="program language-scheme literal-block">
(display &quot;.. raw:: html

   &lt;style&gt;
   pre.program {
       color: navy;
       border-left: 8px solid #eee;
       padding-left: 16px;
       margin-left: 0;
   }
   &lt;/style&gt;

&quot;)
</pre>
</div>
<div class="section" id="additional-markup">
<h2><a class="toc-backref" href="#id7">Additional Markup</a></h2>
<p>When we write a variable, a procedure or a macro name in the text, we'd like
them to appear as literal text. It would also be helpful to assign classes to
their markup. Let's output directives for reStructuredText:</p>
<pre class="program language-scheme literal-block">
(display
&quot;
.. role:: proc(literal)
   :class: procedure

.. role:: var(literal)
   :class: variable

.. role:: value(literal)
   :class: value

.. role:: macro(literal)
   :class: macro

.. role:: module(literal)
   :class: module

&quot;)
</pre>
</div>
<div class="section" id="main-loop">
<h2><a class="toc-backref" href="#id8">Main Loop</a></h2>
<p>Finally, the read-write loop. We'll read lines from the standard input until
we reach the end of file, and process them one-by-one.</p>
<p>We'll use <tt class="procedure docutils literal"><span class="pre">read-line</span></tt> function from <tt class="module docutils literal">rdelim</tt> module and R6RS
control structures, so let's import these modules:</p>
<pre class="program language-scheme literal-block">
(use-modules (ice-9 rdelim)
             (rnrs control))
</pre>
<p>In the loop we read a line from input into variable <tt class="variable docutils literal">s</tt>, and also
remember the last line read in the variable <tt class="variable docutils literal">prev</tt>. We need <tt class="variable docutils literal">prev</tt>
in order to know where to start a code block (if the previous line was a text
line, and the current one is not, then we should start a code block).</p>
<pre class="program language-scheme literal-block">
(let loop ((s (read-line)) (prev &quot;&quot;))
  (unless (eof-object? s)
    (cond
      ((text-line? s) (output-text-line s))
      (else
        (when (text-line? prev) (start-code-block))
        (output-code-line s)))
    (newline)
    (loop (read-line) s)))
</pre>
<p>That's it!</p>
<p><a class="reference external" href="http://dchest.github.io/primlit/primlit.scm">Download source code</a>
and run it with <a class="reference external" href="http://www.gnu.org/software/guile/">Guile</a>.</p>
</div>
</div>
</div>
<div class="footer">
<hr class="footer" />
Generated on: 2011-11-29.

</div>
</body>
</html>
